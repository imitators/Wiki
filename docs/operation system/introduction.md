# 操作系统

对操作系统的了解能让我感受到精密复杂工程中的设计美。

程序对于所有硬件设备的访问都要通过操作系统。

《深入理解计算机系统》将操作系统分为如下部分：

1. 基本模型 + 概念
2. 信号的表示处理
3. 程序机器级表示
4. 处理器体系结构
5. 优化程序性能
6. 存储器层次结构
7. 异常控制流
8. 虚拟内存
9. 系统级I/O
10. 网络编程
11. 并发编程

因为需要向应用靠拢，我重点关注和学习 虚拟内存 和 系统级I/O 两块内容，并揭示他们所存在的设计美和不完美。

## 组成

操作系统由以下部分组成：

- **总线**：贯穿整个系统的一组电子管道
- **I/O 设备**：磁盘，键鼠和显示器等设备
- **主存储器** (DRAM, 主存)：临时存储设备，存放处理器需要的程序和数据
- **处理器**：解释/执行的引擎，核心是寄存器 (register)

处理器一般拥有以下部件：

- **寄存器文件**
- **ALU** (算数逻辑单元, Arithmetic logic unit)
- **cache** (高速缓存存储器, 高速缓存, cache memory)：芯片上的小型缓存，使用 SRAM 硬件技术实现。L1 cache 访问速度几乎和寄存器一样快。一般的 cache 根据容量和访问速度的不同，还会有多级缓存。例如 L1, L2, L3 的三级高速缓存。

### 存储设备

越小越快越贵，越大越慢越便宜。

存储设备中，上一层作为低一层的 cache，能用于优化程序运行效率。

存储设备层次结构如下：

1. L0 寄存器
2. L1 cache
3. L2 cache
4. L3 cache
5. L4 主存储器
6. L5 本地二级存储：磁盘
7. L6 远程二级存储：分布式文件系统、Web 服务器等

## 硬件管理

操作系统使用**进程**、**虚拟内存**和**文件**三个概念对底层硬件进行抽象。

### 进程

**进程**是操作系统对正在运行的程序的抽象，使得每一个程序都看起来独立运行。

**上下文切换**是操作系统实现的处理器交错执行的机制。

切换时保存当前进程的上下文，再恢复新进程的上下文，并将控制权传递到新进程。

> 如何保证切换准确。如果有同名进程会发生什么。
> 
> 控制权怎么传递的。如何干扰控制权的传递？

当应用程序需要操作系统的某些操作时，需要执行特殊的系统调用 (system call)，将控制权传递给内核，内核执行后交回控制权。

> 内核不是进程，而是系统用于管理进程的数据结构和代码的集合。

### 线程

线程被广泛使用源于网络服务器中**对于并行处理的要求**。

每个线程都运行在进程的上下文中，可以共享代码和数据。

在有多处理器的情况下，多线程能加快程序的运行。

### 虚拟内存

虚拟内存空间让每个进程看到的内存保持一致，并让其认为自己独占整个内存空间。

内存结构如下所示：

```

```

## 缓存

缓存利用部分系统物理内存，确保最重要、最常使用的块设备数据在操作时可直接从主内存获取，而无须从低速设备读取。物理内存还用于存储从块设备读取的数据，使得随后对该数据的访问可直接在物理内存进行，而无须从外部设备内取用。