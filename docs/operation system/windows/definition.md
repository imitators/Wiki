# 定义

## 域

域 (Domain) 是 Windows 网络中独立运行的单位。

域是一种管理边界，用于一组计算机共享共用的安全数据库，域实际上就是一组服务器和工作站的集合。

## 域内结构

### 域控制器

​在“域”模式下，域控制器 (Domain Controller，DC) 是用于验证联入网络的电脑和用户的服务器。

域控制器是由工作组计算机升级而成，升级命令为 `dcpromo`。只有 Windows Server (WEB 版本除外) 能升级为域控制器。

在升级DC之前不需要安装DNS服务，域控制器上必须要有NTFS文件系统的分区。

一般一个域内需要有备份域控，保证域控瘫痪时域环境仍然可以使用。

#### 功能

域控制器中包含了由这个域的账户、密码、属于这个域的计算机等信息构成的数据库。

### 活动目录

活动目录 (Adtive Directory, AD) 存储域内资源的信息以帮助用户快速查找。

简单理解为，活动目录是域内资源的索引。

活动目录存储在域控计算机中。

#### 逻辑结构

活动目录中，管理员可以将不同的资源防止在不同的容器中，其中包括以下逻辑结构：组织单元 (OU)，域，域树，域森林。

域树内的所有域共享一个活动目录，这个活动目录的数据分散存储在各个域内，且每个域只存储域内数据。

#### 主要功能

1. 账号集中管理
2. 软件集中管理
3. 环境集中管理
4. 增强安全性
5. 更可靠，更少宕机时间
6. 活动目录为 Microsoft 同一管理的基础平台

### 组织单元

组织单元 (Organization Unit, OU) 是一种容器，里面可以包含对象（用户账户，计算机账户等），也可以包含其他的组织单元。

### DNS 域名服务器

域树的名字就是 DNS 域的名字。

一般情况下，内网渗透时，通过寻找 DNS 服务器来定位域控服务器，因为通常它们在一台机器上。

## 域间结构

### 父域/子域

划分多个域时，第一个域称为父域，其他分部称为该域的子域。

不同的域可以自己管理自己的资源，制定自己的安全策略。

### 域树

域树指若干个域通过建立信任关系 (Trust Relation) 组成的集合。

当两个域建立了信任关系后，域之间能相互访问对方的资源。

在一个域树中，域的名字是连续的，子域只能使用父域作为域名的后缀，例如父域 `hua.com` 和子域 `a.hua.com`。

### 域森林

域森林 (Domain Forest) 指若干个域树通过建立信任关系组成的集合。

## 相关概念

### 内网

​局域网 (Local Area Network, LAN) ，又称内网。

内网的计算机以 NAT（网络地址转换）协议，通过一个公共的网关访问 Internet。

内网的计算机可向 Internet 上的其他计算机发送连接请求，但 Internet 上其他的计算机无法向内网的计算机发送连接请求。

### 工作组

工作组 (Work Group) 用于在大型网络环境中整理计算机。

工作组是一个可以随意改动的标识，同名即为一组。

### 安全域划分

安全域划分的目的是将安全等级相同的计算机划入同一个网段内。通过在网络边界上部署防火墙来实现对其他安全域的 NACL (网络访问控制策略)，当发生攻击时隔绝威胁，减少对域内计算机的影响。

### DMZ

```
                           ------------     ----------
                           |          |     |        |
互联网 -- 外部路由器 -- 防火墙 -- DMZ -- 防火墙 -- 内网  |
                           |          |     |        |
                           ------------     ----------
```

DMZ (demilitarized zone,隔离区)指两个防火墙之间的空间。

DMZ 将外部访问与内网环境相互隔离。

一些必须公开的服务器设施放置在 DMZ 中，如 Web 服务器，FTP 服务器和论坛等。

#### 屏障功能

1. 内网可以白名单访问外网，此时防火墙需要执行 NAT。
2. 内网可以使用并管理 DMZ 中的服务器。
3. 外网不能访问内网（vpn 除外）
4. 外网可以访问 DMZ，此时防火墙完成外部地址到服务器地址的转换。
5. DMZ 不能访问内网
6. DMZ 不能访问外网（部分邮件服务器等除外）

## 域间权限

### 域本地组

> 来自全林作用于本域

域本地组授予其他域的用户访问自己域内资源的权限。

### 全局组

> 来自本域作用于全林

全局组授予自己域的用户访问其他域内资源的权限。

全局组可以嵌套在其他组中。

*只能在创建该全局组的域上进行添加用户和全局组。

### 通用组

> 来自全林作用于全林

通用组授予全局任何用户访问全局任何资源的权限。

### AGDLP 原则

- A (account): 用户账户
- G (Global group): 全局组
- DL (Domain local group): 域本地组
- P (Permission): 许可，资源权限

A-G-DL-P策略是将用户账号添加到全局组中，将全局组添加到域本地组中，然后为域本地组分配资源权限。

```
A域用户 -- A域全局组 -|
                    |-- B域本地组 -- B域资源
B域用户 -- B域全局组 -|

# A/B域用户访问B域资源的权限继承
```

根据上图，B域管理员只需在B域本地组中添加A域全局组，而无需添加A域具体用户。

## 组内权限

### 域本地组

Administrators (管理员组): 最重要的权限
Remote Desktop Users (远程登录组)
Print Operators (打印操作员组)
Account Operators (账号操作员组)
Server Operators (服务器操作员组)
Backup Operators (备份操作员组)

### 全局组、通用组权限

Domain Admins (域管理员组): 最最最重要的权限
Enterprise Admins (企业系统管理员组): 最最重要的权限
Schema Admins (架构管理员组): 最重要的权限
Domain Users (域用户组)